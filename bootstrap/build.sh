#!/bin/bash

#######################################################################################################################
# exit if any command fails

set -e

cd $(dirname ${0})

#######################################################################################################################
# environment variables

WORKDIR=${WORKDIR:=$(realpath $(pwd)/../toolchain/mod-workdir)}

#######################################################################################################################
# setup directories

if [ -n "${GITHUB_ACTIONS}" ]; then
    sudo chown -R 1000:1000 ${WORKDIR}
fi

#######################################################################################################################
# build full boostrap

docker start mpb-container-x86_64

docker exec -i mpb-container-x86_64 /bin/bash <<EOF
git checkout .
./bootstrap.sh x86_64
EOF

docker stop mpb-container-x86_64

#######################################################################################################################
# cleanup

if [ -n "${GITHUB_ACTIONS}" ]; then
    sudo chown -R runner ${WORKDIR}
fi

#######################################################################################################################
# mark as done

touch .stamp_built

#######################################################################################################################
